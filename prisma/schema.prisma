// prisma/schema.prisma
generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

// Enum de Tipo de Cupom
enum TipoCupom {
    PERCENTUAL
    FIXO
}

// Modelo de Cupom
model Cupom {
    id                  String    @id @default(cuid())
    codigo              String    @unique // Ex: "BEMVINDO10"
    descricao           String?
    tipo                TipoCupom
    valor               Float // 10 para 10% ou R$10,00
    valorMinimoPedido   Float? // Pedido mínimo para usar o cupom
    valorMaximoDesconto Float? // Desconto máximo (para percentual)

    // Validade e limites
    dataValidade      DateTime
    maxUsos           Int? // Limite total de usos
    maxUsosPorUsuario Int? // Limite por usuário
    usosAtuais        Int      @default(0)

    // Escopo (opcional - se for específico de um restaurante)
    restauranteId String?
    restaurante   Restaurante? @relation(fields: [restauranteId], references: [id], onDelete: SetNull)

    // Primeiro pedido apenas?
    apenasPrimeiroPedido Boolean @default(false)

    // Status
    ativo Boolean @default(true)

    // Relações
    usos      CupomUso[]
    createdAt DateTime   @default(now())
    updatedAt DateTime   @updatedAt
}

// Controle de usos do cupom
model CupomUso {
    id        String @id @default(cuid())
    cupomId   String
    cupom     Cupom  @relation(fields: [cupomId], references: [id], onDelete: Cascade)
    usuarioId String
    usuario   User   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
    pedidoId  String @unique
    pedido    Pedido @relation(fields: [pedidoId], references: [id], onDelete: Cascade)

    // Valor do desconto aplicado
    valorDesconto Float

    createdAt DateTime @default(now())
}

model RefreshToken {
    id        String    @id @default(cuid())
    token     String    @unique
    userId    String
    user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    expiresAt DateTime
    createdAt DateTime  @default(now())
    revokedAt DateTime?
}

model Restaurante {
    id                String              @id @default(cuid())
    nome              String
    descricao         String?
    cnpj              String              @unique
    telefone          String
    email             String
    enderecoId        String
    endereco          Endereco            @relation(fields: [enderecoId], references: [id])
    proprietarioId    String
    proprietario      User                @relation(fields: [proprietarioId], references: [id])
    horarioAbertura   String? // Formato: "HH:MM"
    horarioFechamento String? // Formato: "HH:MM"
    diasFuncionamento DiasFuncionamento[]
    pedidos           Pedido[]
    avaliacoes        Avaliacao[]
    categorias        Categoria[]
    produtos          Produto[]
    cupons            Cupom[] // ← RELAÇÃO COM CUPONS
    taxaEntrega       Float               @default(0)
    tempoMedioEntrega Int? // Em minutos
    imagemUrl         String?
    ativo             Boolean             @default(true)
    createdAt         DateTime            @default(now())
    updatedAt         DateTime            @updatedAt
}

// Enum de Status do Pedido
enum StatusPedido {
    AGUARDANDO_RESTAURANTE
    CONFIRMADO
    EM_PREPARO
    PRONTO
    SAIU_PARA_ENTREGA
    ENTREGUE
    CANCELADO
}

// Modelo de Pedido
model Pedido {
    id                String      @id @default(cuid())
    clienteId         String
    cliente           User        @relation("PedidosCliente", fields: [clienteId], references: [id])
    restauranteId     String
    restaurante       Restaurante @relation(fields: [restauranteId], references: [id])
    enderecoEntregaId String
    enderecoEntrega   Endereco    @relation("EnderecoEntrega", fields: [enderecoEntregaId], references: [id])

    // Itens do pedido
    itens ItemPedido[]

    // Valores
    subtotal    Float
    taxaEntrega Float
    total       Float

    // Status
    status      StatusPedido @default(AGUARDANDO_RESTAURANTE)
    observacoes String?

    // Controle de tempo
    tempoPreparoEstimado Int? // Minutos estimados
    tempoEntregaReal     Int? // Minutos reais (para métricas)
    dataConfirmacao      DateTime?
    dataInicioPreparo    DateTime?
    dataPronto           DateTime?
    dataSaidaEntrega     DateTime?
    dataEntrega          DateTime?
    dataCancelamento     DateTime?

    // Relações
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relação com avaliação
    avaliacao Avaliacao?

    // Relação com cupom
    cupomUso CupomUso? // ← RELAÇÃO COM CUPOM USO
}

// Modelo de Item do Pedido
model ItemPedido {
    id        String  @id @default(cuid())
    pedidoId  String
    pedido    Pedido  @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
    produtoId String
    produto   Produto @relation(fields: [produtoId], references: [id])

    quantidade    Int
    precoUnitario Float // Preço no momento do pedido (pode mudar depois)
    observacoes   String? // Ex: "Sem cebola", "Ponto da carne"

    createdAt DateTime @default(now())
}

model Avaliacao {
    id            String      @id @default(cuid())
    pedidoId      String      @unique
    pedido        Pedido      @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
    restauranteId String
    restaurante   Restaurante @relation(fields: [restauranteId], references: [id])
    clienteId     String
    cliente       User        @relation(fields: [clienteId], references: [id])

    nota       Int // Validação 1-5 deve ser feita no controller/service
    comentario String?

    createdAt DateTime @default(now())
}

model Produto {
    id            String       @id @default(cuid())
    restauranteId String
    restaurante   Restaurante  @relation(fields: [restauranteId], references: [id], onDelete: Cascade)
    categoriaId   String?
    categoria     Categoria?   @relation(fields: [categoriaId], references: [id], onDelete: SetNull)
    nome          String
    descricao     String?
    preco         Float
    disponivel    Boolean      @default(true)
    destaque      Boolean      @default(false)
    imagemUrl     String?
    itensPedido   ItemPedido[]
    tempoPreparo  Int? // em minutos
    ingredientes  String? // lista de ingredientes
    createdAt     DateTime     @default(now())
    updatedAt     DateTime     @updatedAt

    @@unique([restauranteId, nome]) // Não permite produtos com mesmo nome no mesmo restaurante
}

model Categoria {
    id            String      @id @default(cuid())
    restauranteId String
    restaurante   Restaurante @relation(fields: [restauranteId], references: [id], onDelete: Cascade)
    nome          String
    descricao     String?
    ordem         Int         @default(0)
    produtos      Produto[]
    createdAt     DateTime    @default(now())
    updatedAt     DateTime    @updatedAt

    @@unique([restauranteId, nome]) // Não permite categorias duplicadas no mesmo restaurante
}

model DiasFuncionamento {
    id            String      @id @default(cuid())
    restauranteId String
    restaurante   Restaurante @relation(fields: [restauranteId], references: [id], onDelete: Cascade)
    diaSemana     DiaSemana
    aberto        Boolean     @default(true)
    horarioAbre   String? // "09:00"
    horarioFecha  String? // "22:00"
}

enum DiaSemana {
    SEGUNDA
    TERCA
    QUARTA
    QUINTA
    SEXTA
    SABADO
    DOMINGO
}

model User {
    id            String         @id @default(cuid())
    email         String         @unique
    senhaHash     String
    nome          String
    telefone      String?
    role          Role           @default(CLIENTE)
    enderecos     Endereco[]
    pedidos       Pedido[]       @relation("PedidosCliente")
    restaurantes  Restaurante[]
    refreshTokens RefreshToken[]
    avaliacoes    Avaliacao[]
    usosCupons    CupomUso[] // ← RELAÇÃO COM CUPONS USADOS
    createdAt     DateTime       @default(now())
    updatedAt     DateTime       @updatedAt
}

model Endereco {
    id             String        @id @default(cuid())
    userId         String
    user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    cep            String
    logradouro     String
    numero         String
    complemento    String?
    bairro         String
    cidade         String
    estado         String
    isPrincipal    Boolean       @default(false)
    createdAt      DateTime      @default(now())
    updatedAt      DateTime      @updatedAt
    pedidosEntrega Pedido[]      @relation("EnderecoEntrega")
    restaurantes   Restaurante[]
}

model CepCache {
    cep        String   @id
    logradouro String
    bairro     String
    cidade     String
    estado     String
    updatedAt  DateTime @updatedAt
}

enum Role {
    ADMIN
    DONO_RESTAURANTE
    ENTREGADOR
    CLIENTE
}
